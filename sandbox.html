<!DOCTYPE html>
<html>
<!-- Spell Finder Sandbox v1.2.5 -->

<head>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            background-color: #0f0f0f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: sans-serif;
        }

        #widget-container {
            width: 100%;
            height: 100%;
            display: block;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #0f0f0f;
            z-index: 10;
            transition: opacity 0.3s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #ff0000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Загрузка виджета...</div>
    </div>

    <div id="widget-container"></div>

    <script src="youglish-widget.js"></script>
    <script>
        console.log("Sandbox: Script started. Origin:", window.location.origin);
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');

        let widget = null;
        let pendingSearch = null;

        function initWidget() {
            if (typeof YG === 'undefined') {
                console.log("Sandbox: YG not defined, retrying...");
                setTimeout(initWidget, 100);
                return;
            }
            console.log("Sandbox: YG ready");
            loadingText.textContent = "Готов к поиску";
            window.parent.postMessage({ type: 'ready' }, '*');
        }

        window.addEventListener('message', (event) => {
            const { type, query, language } = event.data;
            if (type === 'search') {
                console.log("Sandbox: Search request", query, language);
                if (typeof YG === 'undefined') {
                    pendingSearch = { query, language };
                    return;
                }
                executeSearch(query, language);
            }
        });

        function executeSearch(query, language) {
            try {
                if (!widget) {
                    console.log("Sandbox: Creating widget instance");
                    widget = new YG.Widget("widget-container", {
                        width: '100%',
                        components: 255,
                        events: {
                            'onFetchDone': (e) => {
                                console.log("Sandbox: Fetch done, results:", e.totalResult);
                                hideOverlay();
                                if (e.totalResult === 0) {
                                    window.parent.postMessage({ type: 'no-results' }, '*');
                                }
                            },
                            'onPlayerReady': () => {
                                console.log("Sandbox: Player ready");
                                hideOverlay();
                            },
                            'onError': (e) => {
                                console.error("Sandbox: YG Error Details:", JSON.stringify(e));
                                let errorMsg = "Ошибка виджета (" + (e.code || "ERR") + ")";
                                if (e.code === 3) errorMsg = "Тайм-аут соединения";
                                loadingText.textContent = errorMsg;
                                loadingOverlay.style.display = 'flex';
                                loadingOverlay.style.opacity = '1';
                            }
                        }
                    });
                }

                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.opacity = '1';
                loadingText.textContent = "Ищем: " + query;

                widget.fetch(query, language || "english");
            } catch (err) {
                console.error("Sandbox: Execution error", err);
                loadingText.textContent = "Ошибка: " + err.message;
            }
        }

        function hideOverlay() {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                if (loadingOverlay.style.opacity === '0') {
                    loadingOverlay.style.display = 'none';
                }
            }, 300);
        }

        initWidget();

        setInterval(() => {
            if (typeof YG !== 'undefined' && pendingSearch) {
                executeSearch(pendingSearch.query, pendingSearch.language);
                pendingSearch = null;
            }
        }, 200);
    </script>
</body>

</html>